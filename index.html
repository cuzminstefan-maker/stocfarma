<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stoc Farma Pro - Audit Edition</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #ef4444;
            --bg: #f8fafc; --border: #e2e8f0; --st-expirat: #fee2e2;
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--primary); }
        
        .top-bar { 
            background: var(--primary); color: white; padding: 12px 16px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .main-container { padding: 12px; max-width: 1400px; margin: auto; }
        .controls { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
        .btn { padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; border: 1px solid var(--border); cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px; min-height: 42px; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-blue { background: var(--accent); color: white; border: none; }
        .btn-white { background: white; color: var(--primary); }
        .btn-inv { background: #6366f1; color: white; border: none; }
        .btn-audit { background: #f59e0b; color: white; border: none; }

        .search-box { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; margin-bottom: 4px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stats-bar { display: flex; justify-content: space-between; padding: 0 4px 10px; font-size: 0.75rem; color: #64748b; }

        .table-card { background: white; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .table-responsive { width: 100%; overflow-x: auto; max-height: calc(100vh - 240px); }
        
        table { width: 100%; border-collapse: collapse; min-width: 850px; table-layout: fixed; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 0.7rem; text-transform: uppercase; color: #64748b; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; }
        td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .input-inline { border: 1px solid transparent; background: transparent; padding: 6px; width: 100%; border-radius: 6px; font-size: 0.9rem; }
        .input-inline:focus { background: #f8fafc; border-color: var(--accent); }
        .qty-box { text-align: center; font-weight: bold; width: 60px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 6px; }
        .pack-box { width: 60px; background: #fffbeb; border: 1px solid #fde68a; text-align: center; font-weight: 800; color: #92400e; }
        
        .row-expirat { background-color: var(--st-expirat) !important; }
        .new-row { background-color: #f0fdf4 !important; }
    </style>
</head>
<body>

<div class="top-bar">
    <h1 id="appTitle" style="font-size: 0.9rem; margin:0; letter-spacing: 0.5px;">STOC FARMA PRO</h1>
    <div style="display: flex; gap: 6px;">
        <button id="undoBtn" class="btn btn-white" style="min-height: 32px; font-size: 0.65rem;" onclick="undo()" disabled>‚Ü© UNDO</button>
        <button class="btn btn-inv" style="min-height: 32px; font-size: 0.65rem;" onclick="toggleModInventar()">INVENTAR</button>
    </div>
</div>

<div class="main-container">
    <div id="normalControls" class="controls">
        <button class="btn btn-blue" onclick="adaugaProdusNou()">+ PRODUS</button>
        <button class="btn btn-white" onclick="document.getElementById('excelInput').click()">üì• IMPORT</button>
        <button class="btn btn-audit" onclick="exportaAudit()">üìä EXPORT AUDIT</button>
        <button class="btn btn-white" onclick="creeazaBackup()">üíæ BACKUP</button>
        <button class="btn btn-white" style="color:var(--danger)" onclick="curataProduseExpirate()">üóëÔ∏è EXPIRATE</button>
        <button class="btn btn-white" style="color:var(--danger)" onclick="stergeIstoric()">üßπ GOLI»öI AUDIT</button>
        
        <input type="file" id="excelInput" style="display: none;" onchange="importaExcelInteligent(event)" />
    </div>

    <div id="inventarControls" class="controls" style="display: none;">
        <button class="btn btn-blue" style="background:var(--success)" onclick="finalizeazaInventar()">‚úÖ GENEREAZƒÇ RAPORT</button>
        <button class="btn btn-white" onclick="toggleModInventar()">ANULEAZƒÇ</button>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="üîé CautƒÉ produs...">
    <div class="stats-bar">
        <span id="txtTotal">Total: 0 produse</span>
        <span id="txtFiltrate" style="display:none; color:var(--accent)">GƒÉsite: 0</span>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table>
                <thead id="headPrincipal"></thead>
                <tbody id="listaCorp"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 1. DATABASE CONFIG (Version 2 include Istoric)
    const db = new Dexie("GestiuneStocDB_Final");
    db.version(1).stores({ 
        produse: '++id, nume, cantitateInt, cantitateFrac, ambalaj, dataExpirare, ordine',
        istoric_verificari: '++id, nume, stocText, dataAudit'
    });

    let modInventar = false;
    let inventarFaptic = {};
    let idProdusNou = null;
    let ultimaStare = null;
    let timeoutCautare = null;

    // 2. SEARCH DEBOUNCING
    document.getElementById('searchInput').addEventListener('keyup', () => {
        clearTimeout(timeoutCautare);
        timeoutCautare = setTimeout(afiseaza, 250);
    });

    // 3. CORE DISPLAY FUNCTION
    async function afiseaza() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const corp = document.getElementById('listaCorp');
        const head = document.getElementById('headPrincipal');
        const azi = new Date();

        let date = await db.produse.orderBy('ordine').reverse().toArray();
        document.getElementById('txtTotal').innerText = `Total: ${date.length} produse`;

        if (query) {
            date = date.filter(p => p.nume.toLowerCase().includes(query));
            document.getElementById('txtFiltrate').innerText = `GƒÉsite: ${date.length}`;
            document.getElementById('txtFiltrate').style.display = 'inline';
        } else {
            document.getElementById('txtFiltrate').style.display = 'none';
        }

        head.innerHTML = modInventar ? 
            `<tr><th style="width:60%">Denumire Produs</th><th style="width:15%; text-align:center;">Emb.</th><th style="width:25%; text-align:center;">NumƒÉrat (I/F)</th></tr>` : 
            `<tr><th style="width:70px;">Ac»õiuni</th><th style="width:40%">Denumire Produs</th><th style="width:10%; text-align:center;">Emb.</th><th style="width:20%; text-align:center;">Stoc (I/F)</th><th style="width:15%; text-align:center;">Exp.</th><th style="width:40px;"></th></tr>`;

        let buffer = "";
        const limita = (query === "" && date.length > 300) ? date.slice(0, 300) : date;

        for (const p of limita) {
            const dExp = parseDataRO(p.dataExpirare);
            const clasaExp = (dExp && dExp < azi) ? 'row-expirat' : '';
            const clasaNou = (p.id === idProdusNou) ? 'new-row' : '';

            if (modInventar) {
                buffer += `<tr class="${clasaNou}">
                    <td><b>${p.nume}</b></td>
                    <td style="text-align:center;">${p.ambalaj}</td>
                    <td style="text-align:center;">
                        <input type="number" class="qty-box" onchange="updateFaptic(${p.id}, 'int', this.value)">
                        <input type="number" class="qty-box" style="border-color:var(--accent)" onchange="updateFaptic(${p.id}, 'frac', this.value)">
                    </td></tr>`;
            } else {
                buffer += `<tr class="${clasaExp} ${clasaNou}">
                    <td style="white-space:nowrap;">
                        <button class="btn-white" style="color:var(--accent); padding:5px 8px;" onclick="duplica(${p.id}, ${p.ordine})">+</button>
                        <button class="btn-white" style="color:var(--primary); padding:5px 8px;" onclick="verificaStoc(${p.id})">üëÅÔ∏è</button>
                    </td>
                    <td><input type="text" class="input-inline" style="font-weight:600" value="${p.nume}" onchange="reincarcaStoc(${p.id}, 'nume', this.value)" onkeyup="checkEnter(event, this)"></td>
                    <td style="text-align:center;"><input type="number" class="input-inline pack-box" value="${p.ambalaj || 10}" onchange="reincarcaStoc(${p.id}, 'ambalaj', this.value)" onkeyup="checkEnter(event, this)"></td>
                    <td style="text-align:center;">
                        <input type="number" class="qty-box" value="${p.cantitateInt}" onfocus="this.select()" onchange="reincarcaStoc(${p.id}, 'cantitateInt', this.value)" onkeyup="checkEnter(event, this)">
                        <input type="number" class="qty-box" style="color:var(--accent)" value="${p.cantitateFrac}" onfocus="this.select()" onchange="reincarcaStoc(${p.id}, 'cantitateFrac', this.value)" onkeyup="checkEnter(event, this)">
                    </td>
                    <td><input type="text" class="input-inline" style="text-align:center" value="${p.dataExpirare || ''}" oninput="formatareData(this)" onchange="reincarcaStoc(${p.id}, 'dataExpirare', this.value)" onkeyup="checkEnter(event, this)"></td>
                    <td><button onclick="sterge(${p.id})" style="border:none; background:none; opacity:0.1;">üóëÔ∏è</button></td></tr>`;
            }
        }
        corp.innerHTML = buffer;
    }

    // 4. VERIFCARE RAPIDA & ISTORIC
    async function verificaStoc(id) {
        const p = await db.produse.get(id);
        const total = (p.cantitateInt * p.ambalaj) + p.cantitateFrac;
        const stocText = `${p.cantitateInt}i / ${p.cantitateFrac}f (Total: ${total})`;
        const acum = new Date().toLocaleString('ro-RO');

        await db.istoric_verificari.add({ nume: p.nume, stocText: stocText, dataAudit: acum });
        alert(`üëÅÔ∏è VERIFICARE: ${p.nume}\n--------------------------\nSTOC: ${stocText}\nEXPIRƒÇ: ${p.dataExpirare || '-'}\n--------------------------\nSalvat √Æn Istoric Audit.`);
    }

    async function exportaAudit() {
        const dateAudit = await db.istoric_verificari.toArray();
        if (dateAudit.length === 0) return alert("Istoric gol!");
        const ws = XLSX.utils.json_to_sheet(dateAudit);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Audit");
        XLSX.writeFile(wb, `Audit_Farma_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    async function stergeIstoric() { if(confirm("»òterge»õi tot istoricul de audit?")) { await db.istoric_verificari.clear(); alert("Istoric curƒÉ»õat!"); } }

    // 5. CORE LOGIC (REINCARCARE, UNDO, EXCEL)
    async function reincarcaStoc(id, camp, val) {
        await salveazaUndo();
        let p = await db.produse.get(id);
        let nVal = (camp === 'nume' || camp === 'dataExpirare') ? val : parseInt(val) || 0;
        let cI = p.cantitateInt, cF = p.cantitateFrac, amb = p.ambalaj || 1;
        if (camp === 'cantitateInt') cI = nVal;
        if (camp === 'cantitateFrac') cF = nVal;
        if (camp === 'ambalaj') amb = nVal > 0 ? nVal : 1;
        if (cF >= amb) { cI += Math.floor(cF / amb); cF = cF % amb; }
        await db.produse.update(id, { nume:p.nume, dataExpirare:p.dataExpirare, cantitateInt:cI, cantitateFrac:cF, ambalaj:amb, [camp]:nVal });
        afiseaza();
    }

    async function adaugaProdusNou() { idProdusNou = await db.produse.add({ nume: "Produs Nou", cantitateInt: 0, cantitateFrac: 0, ambalaj: 10, dataExpirare: "", ordine: Date.now() }); afiseaza(); }
    async function duplica(id, ord) { const p = await db.produse.get(id); const {id: u, ...copie} = p; copie.cantitateInt = 0; copie.cantitateFrac = 0; copie.ordine = ord + 1; idProdusNou = await db.produse.add(copie); afiseaza(); }
    async function sterge(id) { if(confirm("»òtergi?")) { await db.produse.delete(id); afiseaza(); } }

    async function importaExcelInteligent(e) {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = async (ev) => {
            const data = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).Sheets[0]);
            const decizie = confirm(`ImportƒÉm ${data.length} r√¢nduri?\nOK -> CUMULARE stoc\nCANCEL -> √éNLOCUIRE stoc`);
            const existente = await db.produse.toArray();
            for (let row of data) {
                const fK = (keys) => Object.keys(row).find(k => keys.some(key => k.toLowerCase().includes(key)));
                let den = (row[fK(['nume', 'prod', 'denu'])] || "Import").toString().trim();
                let cI = parseInt(row[fK(['stoc', 'buc', 'qty', 'intreg'])]) || 0;
                let cF = parseInt(row[fK(['frac', 'tab', 'fiol'])]) || 0;
                let amb = parseInt(row[fK(['amb', 'pack', 'impach'])]) || 10;
                let exp = (row[fK(['exp', 'data', 'valab'])] || "").toString().trim();
                let pEx = existente.find(x => x.nume.toLowerCase() === den.toLowerCase());
                if (pEx) {
                    let fI = decizie ? pEx.cantitateInt + cI : cI;
                    let fF = decizie ? pEx.cantitateFrac + cF : cF;
                    if (fF >= amb) { fI += Math.floor(fF / amb); fF = fF % amb; }
                    await db.produse.update(pEx.id, { cantitateInt: fI, cantitateFrac: fF, dataExpirare: exp || pEx.dataExpirare, ambalaj: amb });
                } else {
                    await db.produse.add({ nume: den, cantitateInt: cI, cantitateFrac: cF, ambalaj: amb, dataExpirare: exp, ordine: Date.now() });
                }
            }
            afiseaza(); alert("Import Finalizat!");
        };
        r.readAsArrayBuffer(f);
    }

    // UTILS
    function checkEnter(e, el) { if (e.key === "Enter") el.blur(); }
    function formatareData(i) { let v = i.value.replace(/\D/g, '').slice(0, 8); if (v.length >= 2 && v.length < 4) v = v.slice(0, 2) + '/' + v.slice(2); else if (v.length >= 4) v = v.slice(0, 2) + '/' + v.slice(2, 4) + '/' + v.slice(4); i.value = v; }
    function parseDataRO(s) { if (!s || s.length < 8) return null; const p = s.split(/[\/\.\-]/); return new Date((p[2].length===2?"20"+p[2]:p[2]), p[1]-1, p[0]); }
    async function salveazaUndo() { ultimaStare = await db.produse.toArray(); document.getElementById('undoBtn').disabled = false; }
    async function undo() { if (ultimaStare) { await db.produse.clear(); await db.produse.bulkAdd(ultimaStare); ultimaStare = null; document.getElementById('undoBtn').disabled = true; afiseaza(); } }
    async function creeazaBackup() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(await db.produse.toArray())], {type:'application/json'})); a.download = `Backup_Stoc.json`; a.click(); }
    function toggleModInventar() { modInventar = !modInventar; document.getElementById('normalControls').style.display = modInventar ? 'none' : 'flex'; document.getElementById('inventarControls').style.display = modInventar ? 'flex' : 'none'; afiseaza(); }
    function updateFaptic(id, t, v) { if (!inventarFaptic[id]) inventarFaptic[id]={int:0, frac:0}; inventarFaptic[id][t]=parseInt(v)||0; }
    async function curataProduseExpirate() { const azi = new Date(); const p = await db.produse.toArray(); const ds = p.filter(x => { const d=parseDataRO(x.dataExpirare); return d && d < azi; }).map(x => x.id); if(ds.length && confirm(`»òtergem ${ds.length} expirate?`)) { await db.produse.bulkDelete(ds); afiseaza(); } }
    async function finalizeazaInventar() { const p = await db.produse.toArray(); const body = p.map(x => { const f = inventarFaptic[x.id] || {int:0, frac:0}; return [x.nume, `${x.cantitateInt}i/${x.cantitateFrac}f`, `${f.int}i/${f.frac}f`, (f.int*x.ambalaj+f.frac) - (x.cantitateInt*x.ambalaj+x.cantitateFrac)]; }); const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Raport Diferente", 14, 15); doc.autoTable({head:[['Produs','Sistem','Raft','Dif.Unit']], body:body, startY:20}); doc.save("Inventar.pdf"); toggleModInventar(); }

    afiseaza();
</script>
</body>
</html>

