<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stoc Farma Pro - Filtre Avansate</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #ef4444;
            --bg: #f8fafc; --border: #e2e8f0; --st-expirat: #fee2e2;
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--primary); }
        
        .top-bar { 
            background: var(--primary); color: white; padding: 12px 16px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .main-container { padding: 12px; max-width: 1200px; margin: auto; }
        .controls { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
        .controls::-webkit-scrollbar { display: none; }

        .btn { padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; border: 1px solid var(--border); cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px; min-height: 42px; transition: 0.2s; }
        .btn-blue { background: var(--accent); color: white; border: none; }
        .btn-white { background: white; color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; border: none; }

        .btn-delete { 
            background: #fff1f2; color: #be123c; border: 1px solid #fda4af; 
            padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        .search-box { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; margin-bottom: 8px; background: white; }
        
        .stats-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 5px 10px; font-size: 0.8rem; color: #64748b; }

        .table-card { background: white; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .table-responsive { width: 100%; overflow-x: auto; max-height: 70vh; }
        
        table { width: 100%; border-collapse: collapse; min-width: 850px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 0.75rem; color: #64748b; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; cursor: pointer; }
        th:hover { background: #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .input-inline { border: 1px solid transparent; background: transparent; padding: 8px; width: 100%; border-radius: 6px; font-size: 0.95rem; }
        .qty-box { width: 65px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px; text-align: center; font-weight: bold; }
        
        .row-expirat { background-color: var(--st-expirat) !important; }
    </style>
</head>
<body>

<div class="top-bar">
    <h1 style="font-size: 0.9rem; margin:0;">STOC FARMA PRO</h1>
    <button class="btn btn-white" style="background:#6366f1; color:white; border:none;" onclick="toggleModInventar()">MOD INVENTAR</button>
</div>

<div class="main-container">
    <div id="normalControls" class="controls">
        <button class="btn btn-blue" onclick="adaugaProdusNou()">+ PRODUS</button>
        <button class="btn btn-white" onclick="document.getElementById('excelInput').click()">üì• IMPORT EXCEL</button>
        <button class="btn btn-white" onclick="creeazaBackup()">üíæ BACKUP</button>
        <button class="btn btn-white" onclick="document.getElementById('restoreInput').click()">üîÑ RESTORE</button>
        <input type="file" id="excelInput" style="display: none;" accept=".xlsx, .xls" onchange="importaExcel(event)" />
        <input type="file" id="restoreInput" style="display: none;" accept=".json" onchange="restaurareBackup(event)" />
    </div>

    <div id="inventarControls" class="controls" style="display: none;">
        <button class="btn btn-blue" onclick="exportaInventarExcel()">üìä EXPORT EXCEL</button>
        <button class="btn btn-danger" onclick="toggleModInventar()">√éNCHIDE</button>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="üîé CautƒÉ dupƒÉ denumire..." onkeyup="afiseaza()">

    <div class="stats-bar">
        <div>
            <span id="txtTotal">Total: 0</span> | 
            <span style="color:var(--danger); cursor:pointer" onclick="filtreazaSpeciale('expirate')">üö© Vezi Expirate</span> |
            <span style="color:var(--accent); cursor:pointer" onclick="afiseaza()">üîÑ Toate</span>
        </div>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th style="width:70px">Audit</th>
                        <th onclick="sorteaza('nume')">Produs ‚ÜïÔ∏è</th>
                        <th style="text-align:center; width:80px">Emb.</th>
                        <th style="text-align:center; width:150px">Stoc (I/F)</th>
                        <th onclick="sorteaza('expirare')" style="text-align:center; width:120px">Expira ‚ÜïÔ∏è</th>
                        <th style="width:50px"></th>
                    </tr>
                </thead>
                <tbody id="listaCorp"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const db = new Dexie("FarmaProDB_V4");
    db.version(1).stores({ produse: '++id, nume, cantitateInt, cantitateFrac, ambalaj, dataExpirare, ordine' });

    let modInventar = false;
    let sensSortare = { nume: 1, expirare: 1 };

    async function afiseaza(dateSursa = null) {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const corp = document.getElementById('listaCorp');
        const azi = new Date();

        let date = dateSursa || await db.produse.toArray();
        if (query && !dateSursa) date = date.filter(p => p.nume.toLowerCase().includes(query));

        document.getElementById('txtTotal').innerText = `Total: ${date.length}`;

        corp.innerHTML = date.map(p => {
            const dExp = parseDataRO(p.dataExpirare);
            const esteExpirat = dExp && dExp < azi;
            
            if (modInventar) {
                return `<tr class="${esteExpirat ? 'row-expirat' : ''}">
                    <td><button class="btn-white" onclick="duplica(${p.id})">+</button></td>
                    <td><input class="input-inline" style="font-weight:bold" value="${p.nume}" onchange="updateProd(${p.id}, 'nume', this.value)"></td>
                    <td align="center">${p.ambalaj}</td>
                    <td align="center">
                        <input type="number" class="qty-box" placeholder="I" onchange="updateFaptic(${p.id}, 'int', this.value)">
                        <input type="number" class="qty-box" placeholder="F" onchange="updateFaptic(${p.id}, 'frac', this.value)">
                    </td>
                    <td><input class="input-inline" style="text-align:center" value="${p.dataExpirare}" placeholder="ZZ/LL/AA" oninput="formatareData(this)" onchange="updateProd(${p.id}, 'dataExpirare', this.value)"></td>
                    <td><button class="btn-delete" onclick="sterge(${p.id})">üóëÔ∏è</button></td>
                </tr>`;
            } else {
                return `<tr class="${esteExpirat ? 'row-expirat' : ''}">
                    <td><button class="btn-white" style="font-size:1.2rem" onclick="verificaStoc(${p.id})">üëÅÔ∏è</button></td>
                    <td><b>${p.nume}</b></td>
                    <td align="center">${p.ambalaj}</td>
                    <td align="center"><b>${p.cantitateInt}i</b> / <span style="color:var(--accent)">${p.cantitateFrac}f</span></td>
                    <td align="center">${p.dataExpirare || '-'}</td>
                    <td><button class="btn-delete" style="padding:4px 8px" onclick="sterge(${p.id})">üóëÔ∏è</button></td>
                </tr>`;
            }
        }).join('');
    }

    async function sorteaza(camp) {
        let date = await db.produse.toArray();
        sensSortare[camp] *= -1;

        date.sort((a, b) => {
            if (camp === 'nume') {
                return a.nume.localeCompare(b.nume) * sensSortare[camp];
            } else {
                const dA = parseDataRO(a.dataExpirare) || new Date(2099, 1, 1);
                const dB = parseDataRO(b.dataExpirare) || new Date(2099, 1, 1);
                return (dA - dB) * sensSortare[camp];
            }
        });
        afiseaza(date);
    }

    async function filtreazaSpeciale(tip) {
        const date = await db.produse.toArray();
        const azi = new Date();
        if (tip === 'expirate') {
            const filtrate = date.filter(p => { const d = parseDataRO(p.dataExpirare); return d && d < azi; });
            afiseaza(filtrate);
        }
    }

    async function verificaStoc(id) {
        const p = await db.produse.get(id);
        const stocSistem = (p.cantitateInt * p.ambalaj) + p.cantitateFrac;
        const faptic = prompt(`AUDIT: ${p.nume}\nSISTEM: ${stocSistem} unitƒÉ»õi\nRAFT (unitƒÉ»õi):`, stocSistem);
        if (faptic === null) return;
        const nF = parseInt(faptic) || 0;
        if (confirm(`ActualizƒÉm stocul la ${nF} unitƒÉ»õi?`)) {
            await db.produse.update(id, { cantitateInt: Math.floor(nF / p.ambalaj), cantitateFrac: nF % p.ambalaj });
            afiseaza();
        }
    }

    async function restaurareBackup(e) {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = async (ev) => {
            const date = JSON.parse(ev.target.result);
            if (confirm(`RestaurƒÉm ${date.length} produse?`)) {
                await db.produse.clear();
                await db.produse.bulkAdd(date);
                afiseaza();
            }
        };
        r.readAsText(f);
    }

    async function adaugaProdusNou() { await db.produse.add({ nume: "Produs Nou", cantitateInt: 0, cantitateFrac: 0, ambalaj: 10, dataExpirare: "", ordine: Date.now() }); afiseaza(); }
    async function duplica(id) { const p = await db.produse.get(id); delete p.id; p.ordine = Date.now(); await db.produse.add(p); afiseaza(); }
    async function sterge(id) { if(confirm("»òtergi?")) { await db.produse.delete(id); afiseaza(); } }
    async function updateProd(id, c, v) { await db.produse.update(id, { [c]: v }); }
    function toggleModInventar() { modInventar = !modInventar; afiseaza(); }
    function formatareData(i) { let v = i.value.replace(/\D/g,''); if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2); if(v.length>5) v=v.slice(0,5)+'/'+v.slice(5,7); i.value=v; }
    function parseDataRO(s) { if(!s || s.length<8) return null; const p = s.split('/'); return new Date("20"+p[2], p[1]-1, p[0]); }
    function creeazaBackup() { db.produse.toArray().then(d => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], {type:'application/json'})); a.download = `Backup.json`; a.click(); }); }
    
    afiseaza();
</script>
</body>
</html>

